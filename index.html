<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BS MART | Online Shopping</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .receipt-tear {
            background-image: linear-gradient(135deg, white 50%, transparent 50%), linear-gradient(45deg, white 50%, transparent 50%);
            background-position: bottom;
            background-size: 20px 20px;
            background-repeat: repeat-x;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-24 select-none">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby7FbnXt9tqKFK_OfuUd7dVwdSmYunenmvLJGY9yGmpHUI2NDDzPXPIYnDhfHRiP_2q/exec"; 
        
        // YOUR QR CODE
        const QR_CODE_IMAGE = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=bsuheem23@okhdfcbank&pn=Bhat%20Suheem";
    </script>

    <nav class="bg-[#232f3e] text-white sticky top-0 z-50 shadow-md">
        <div class="relative flex justify-between items-center px-4 py-3">
            <button class="text-xl z-10"><i class="fa-solid fa-bars"></i></button>

            <div onclick="adminLoginTrigger()" class="absolute inset-0 flex justify-center items-center cursor-pointer z-20">
                <span class="text-xl font-bold tracking-wider select-none">BS <span class="text-[#febd69]">MART</span></span>
            </div>

            <div class="relative z-10">
                <i class="fa-solid fa-cart-shopping text-xl"></i>
                <span class="absolute -top-2 -right-2 bg-[#febd69] text-[#232f3e] text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </div>
        </div>

        <div class="px-3 pb-3">
            <div class="flex bg-white rounded-md overflow-hidden h-10">
                <input type="text" id="search" onkeyup="searchProducts()" placeholder="Search BS MART..." class="w-full px-4 text-gray-700 outline-none text-sm">
                <button onclick="searchProducts()" class="bg-[#febd69] w-12 flex justify-center items-center text-gray-800"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
        </div>

        <div class="bg-[#37475a] py-2 overflow-x-auto no-scrollbar">
            <div class="flex px-4 space-x-5 text-sm font-medium text-white min-w-max">
                <span onclick="filterProducts('All')" class="cursor-pointer hover:text-[#febd69]">All</span>
                <span onclick="filterProducts('Mens Wear')" class="cursor-pointer hover:text-[#febd69]">Men</span>
                <span onclick="filterProducts('Womens')" class="cursor-pointer hover:text-[#febd69]">Women</span>
                <span onclick="filterProducts('Electronics')" class="cursor-pointer hover:text-[#febd69]">Electronics</span>
            </div>
        </div>
    </nav>

    <div id="main-view">
        <div id="loading" class="text-center py-20">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-[#232f3e]"></i>
            <p class="mt-2 text-gray-500">Loading Products...</p>
        </div>
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 p-2"></div>
        
        <div class="mt-8 bg-white py-8 px-5 text-center border-t shadow-sm">
            <h2 class="text-xl font-bold text-[#232f3e] mb-2">Why Shop at BS MART?</h2>
            
            <div class="flex justify-center gap-4 text-xs text-gray-600 mb-6">
                <div class="flex flex-col items-center"><i class="fa-solid fa-truck-fast text-2xl text-[#febd69] mb-1"></i><span>Fast Delivery</span></div>
                <div class="flex flex-col items-center"><i class="fa-solid fa-shield-halved text-2xl text-[#febd69] mb-1"></i><span>Secure Payment</span></div>
            </div>

            <div class="text-left text-sm text-gray-600 space-y-2 bg-gray-50 p-4 rounded-lg border border-gray-100">
                <p><strong>BS MART</strong> is your premium destination for fashion and electronics. We bring you the latest trends at the most affordable prices with a seamless shopping experience.</p>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <p class="font-bold text-[#232f3e] mb-1">Need Help?</p>
                    <p><i class="fa-solid fa-envelope text-[#febd69] mr-2"></i> <a href="mailto:suheemsuheem752@gmail.com" class="text-blue-600 font-bold hover:underline">suheemsuheem752@gmail.com</a></p>
                </div>
            </div>

            <p class="text-xs text-gray-400 mt-6">Â© 2026 BS MART Inc.</p>
        </div>
    </div>

    <div id="product-page" class="fixed inset-0 bg-white z-[60] hidden overflow-y-auto fade-in">
        <div class="bg-[#232f3e] text-white p-3 flex items-center gap-3 sticky top-0 shadow">
            <button onclick="closeProductPage()"><i class="fa-solid fa-arrow-left text-lg"></i></button>
            <span class="font-bold truncate" id="pp-header-title">Details</span>
        </div>
        <div class="p-4 pb-32">
            <div class="relative">
                <div class="h-72 flex justify-center items-center bg-gray-50 mb-4 rounded-lg border">
                    <img id="pp-img" src="" class="max-h-full max-w-full object-contain">
                </div>
                <span id="pp-badge" class="hidden absolute top-2 right-2 bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow animate-pulse"></span>
            </div>
            <h1 id="pp-title" class="text-lg font-medium text-gray-800 leading-snug mb-2"></h1>
            <div class="bg-gray-50 p-3 rounded mb-4 border border-gray-100">
                <div class="flex items-baseline gap-2">
                    <span id="pp-discount-text" class="text-orange-600 text-xl font-light hidden"></span>
                    <span class="text-3xl font-bold text-gray-900">â‚¹<span id="pp-price"></span></span>
                </div>
                <p id="pp-mrp-block" class="text-xs text-gray-500 mt-1 hidden">M.R.P.: <span class="line-through" id="pp-old-price"></span></p>
            </div>
            
            <div id="size-section" class="mb-5">
                <p class="font-bold text-sm mb-2 text-gray-800">Select Size</p>
                <div class="flex gap-3">
                    <button onclick="selectSize(this, 'S')" class="size-btn border rounded-md px-4 py-2 text-sm font-bold hover:bg-gray-100">S</button>
                    <button onclick="selectSize(this, 'M')" class="size-btn border rounded-md px-4 py-2 text-sm font-bold hover:bg-gray-100">M</button>
                    <button onclick="selectSize(this, 'L')" class="size-btn border rounded-md px-4 py-2 text-sm font-bold hover:bg-gray-100">L</button>
                    <button onclick="selectSize(this, 'XL')" class="size-btn border rounded-md px-4 py-2 text-sm font-bold hover:bg-gray-100">XL</button>
                </div>
                <p id="size-error" class="text-red-500 text-xs mt-1 hidden font-bold">Please select a size!</p>
            </div>

            <hr class="border-gray-200 my-4">
            
            <div class="mb-6">
                <h3 class="font-bold text-md mb-2">Description</h3>
                <p id="pp-desc" class="text-sm text-gray-600 leading-relaxed"></p>
            </div>
            
            <div class="mb-6">
                <h3 class="font-bold text-md mb-3">Customer Reviews</h3>
                <div id="pp-reviews" class="space-y-4 mb-6"></div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-sm mb-2">Write a Review</h4>
                    <select id="review-stars" class="w-full border p-2 rounded text-sm mb-2 text-yellow-500 font-bold">
                        <option value="â˜…â˜…â˜…â˜…â˜…">â˜…â˜…â˜…â˜…â˜… (Excellent)</option>
                        <option value="â˜…â˜…â˜…â˜…â˜†">â˜…â˜…â˜…â˜…â˜† (Good)</option>
                    </select>
                    <textarea id="review-text" class="w-full border p-2 rounded text-sm mb-2" placeholder="Describe your experience..."></textarea>
                    <button onclick="submitReview()" class="w-full bg-[#232f3e] text-white text-sm py-2 rounded font-bold hover:bg-black">Submit Review</button>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 bg-white p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <button onclick="openCheckoutFromPage()" class="w-full bg-[#ffd814] text-black py-3 rounded-full font-bold shadow-sm border border-[#fcd200] hover:bg-[#f7ca00]">Buy Now</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[70] hidden flex items-center justify-center fade-in p-4">
        <div class="bg-white w-full max-w-sm rounded-lg p-5 relative shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold">Order Summary</h2>
                <button onclick="toggleModal('checkout-modal')" class="text-gray-500 text-2xl">&times;</button>
            </div>
            
            <form id="order-form" onsubmit="submitOrder(event)" enctype="multipart/form-data">
                <input type="hidden" name="_subject" value="New BS MART Order (Verified)">
                <input type="hidden" name="_captcha" value="false">
                
                <input type="hidden" id="form-name" name="Product">
                <input type="hidden" id="form-price" name="Price">
                <input type="hidden" id="form-size" name="Size">
                
                <div class="space-y-3">
                    <input type="text" id="cust-name" name="Name" placeholder="Full Name" required class="w-full border rounded p-2 text-sm outline-none focus:border-[#e77600]">
                    <input type="tel" name="Mobile" placeholder="Mobile Number" required class="w-full border rounded p-2 text-sm outline-none focus:border-[#e77600]">
                    
                    <input type="tel" name="Pin_Code" placeholder="Pin Code" required class="w-full border rounded p-2 text-sm outline-none focus:border-[#e77600]">

                    <input type="text" name="Landmark" placeholder="Nearby Landmark" required class="w-full border rounded p-2 text-sm outline-none focus:border-[#e77600]">

                    <textarea name="Address" placeholder="Full Address (House No, Street, Colony)" required class="w-full border rounded p-2 text-sm outline-none focus:border-[#e77600]" rows="3"></textarea>
                    
                    <div class="bg-gray-50 p-3 rounded border">
                        <p class="font-bold text-xs mb-2 text-gray-700">Payment Method</p>
                        <label class="flex items-center gap-2 mb-2 cursor-pointer">
                            <input type="radio" name="Payment" value="COD" checked onclick="togglePaymentMethod('COD')" class="accent-[#e77600]">
                            <span class="text-sm">Cash on Delivery</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="Payment" value="Online" onclick="togglePaymentMethod('Online')" class="accent-[#e77600]">
                            <span class="text-sm">UPI / QR Code</span>
                        </label>
                        
                        <div id="qr-box" class="hidden text-center mt-2 border-t pt-2">
                            <img id="qr-img" src="" class="w-32 h-32 mx-auto border bg-white p-1 mb-2">
                            <p class="text-[10px] text-red-500 mt-1 font-bold mb-2">Scan & Pay Now</p>
                            
                            <div class="text-left bg-white p-2 border border-dashed border-gray-400 rounded relative">
                                <label class="text-[11px] font-bold text-gray-700 block mb-1">Upload Payment Screenshot:</label>
                                <input type="file" id="pay-screenshot" name="Payment_Screenshot" accept="image/*" class="w-full text-xs" disabled>
                            </div>
                            
                            <div id="scan-status" class="hidden mt-2 p-2 bg-blue-50 text-blue-800 text-xs rounded border border-blue-200">
                                <i class="fa-solid fa-spinner fa-spin"></i> Reading Screenshot...
                            </div>
                            
                            <p class="text-[10px] text-gray-500 mt-1 font-bold">*System will verify if â‚¹<span id="qr-amount-display">0</span> is in the image.</p>
                        </div>
                    </div>
                </div>
                <button type="submit" id="place-order-btn" class="w-full bg-[#ffd814] border border-[#fcd200] py-3 rounded-lg font-bold mt-4 shadow hover:bg-[#f7ca00]">Place Order</button>
            </form>
        </div>
    </div>

    <div id="invoice-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[80] hidden flex items-center justify-center fade-in p-4">
        <div class="bg-white w-full max-w-sm rounded-none shadow-2xl relative overflow-hidden">
            <div class="bg-[#232f3e] text-white p-4 text-center">
                <h2 class="text-xl font-bold tracking-wider">BS <span class="text-[#febd69]">MART</span></h2>
                <p class="text-[10px] opacity-80">ORDER CONFIRMATION</p>
            </div>
            
            <div class="p-6">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-circle-check text-green-500 text-4xl mb-2"></i>
                    <h3 class="font-bold text-lg text-gray-800">Order Placed!</h3>
                    <p class="text-xs text-gray-500">Status: <span class="text-green-600 font-bold">Confirmed</span> <i class="fa-solid fa-check-double ml-1"></i></p>
                </div>

                <div class="space-y-2 text-sm mb-6 border-b border-dashed pb-4">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Order ID:</span>
                        <span class="font-mono font-bold" id="inv-id">#10293</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Customer:</span>
                        <span class="font-bold" id="inv-name">User</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Payment:</span>
                        <span class="font-bold" id="inv-mode">Online</span>
                    </div>
                </div>

                <button onclick="location.reload()" class="w-full bg-[#232f3e] text-white py-3 font-bold text-sm tracking-widest hover:bg-black">CONTINUE SHOPPING</button>
            </div>
            <div class="receipt-tear h-4 w-full absolute bottom-[-10px]"></div>
        </div>
    </div>

    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-80 z-[90] hidden flex items-center justify-center fade-in">
        <div class="bg-white p-6 rounded w-80 max-h-[80vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-3">Add Product</h3>
            <p class="text-xs text-gray-500 mb-4">Adding directly to Google Sheet is recommended.</p>
            <form onsubmit="event.preventDefault(); uploadProduct();" class="space-y-2">
                <input type="text" id="a-name" placeholder="Product Title" class="w-full border p-2 rounded text-sm">
                <div class="flex gap-2">
                    <input type="number" id="a-price" placeholder="Price (â‚¹)" class="w-full border p-2 rounded text-sm">
                    <input type="number" id="a-old-price" placeholder="MRP (Old Price)" class="w-full border p-2 rounded text-sm bg-orange-50">
                </div>
                <select id="a-cat" class="w-full border p-2 rounded text-sm">
                    <option value="Mens Wear">Mens Wear</option>
                    <option value="Womens">Womens</option>
                    <option value="Electronics">Electronics</option>
                </select>
                <textarea id="a-desc" placeholder="Product Description..." class="w-full border p-2 rounded text-sm"></textarea>
                <p class="text-xs font-bold">Image (Upload from Phone)</p>
                <input type="file" id="a-img" class="w-full text-xs">
                <button type="submit" id="upload-btn" class="w-full bg-[#232f3e] text-white py-2 rounded mt-2">Add Product</button>
                <button type="button" onclick="toggleModal('admin-panel')" class="w-full text-gray-500 mt-2 text-sm">Close</button>
            </form>
        </div>
    </div>

    <script>
        let allProducts = [];
        let displayedProducts = []; 
        let selectedSize = null;
        let currentProduct = null;

        // FAKE REVIEWS ARRAY
        const fakeReviews = [
            "Amazing quality for this price! ðŸ˜|Very comfortable fabric.|Delivery was super fast.",
            "Best purchase ever.|Fitting is perfect.|Will order again for sure.",
            "Material is soft and durable.|Looks exactly like the photo.|Value for money ðŸ’¯",
            "Highly recommended! â­â­â­â­â­|Loved the packaging.",
            "Good product, value for money.|Fast delivery."
        ];

        const CACHE_KEY = 'bs_mart_cache_v1';
        
        // Load from Cache immediately
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
            try { 
                allProducts = JSON.parse(cachedData); 
                document.getElementById('loading').style.display = 'none'; 
                renderGrid(allProducts); 
            } catch(e) {}
        }

        // Fetch Fresh Data
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                allProducts = data;
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                document.getElementById('loading').style.display = 'none';
                renderGrid(data);
            })
            .catch(err => console.log("Network Error"));

        function getOldPrice(p) { return p.Old_Price || p["Old Price"] || p.MRP || 0; }

        function renderGrid(products) {
            displayedProducts = products;
            const grid = document.getElementById('product-grid');
            grid.innerHTML = "";
            products.forEach((p, index) => {
                const price = Number(p.Price || p.price);
                const oldPrice = Number(getOldPrice(p)); 
                
                let discountHTML = "";
                let oldPriceHTML = "";
                
                if (oldPrice > price) {
                    discountHTML = `<span class="absolute top-2 left-2 bg-orange-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded">${Math.floor(((oldPrice - price) / oldPrice) * 100)}% off</span>`;
                    oldPriceHTML = `<span class="text-xs text-gray-500 line-through ml-1">â‚¹${oldPrice}</span>`;
                }
                
                grid.innerHTML += `
                    <div onclick="openProduct(${index})" class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm relative cursor-pointer hover:shadow-md">
                        ${discountHTML}
                        <div class="h-40 flex justify-center items-center bg-gray-50 mb-2 rounded overflow-hidden">
                            <img src="${p.Image || p.image}" class="h-full object-contain mix-blend-multiply">
                        </div>
                        <h3 class="text-xs font-bold text-gray-800 line-clamp-2 h-8 leading-4 mb-1">${p.Name || p.name}</h3>
                        <div class="flex items-baseline gap-1 mt-1">
                            <span class="text-sm font-bold text-gray-900">â‚¹${price}</span>
                            ${oldPriceHTML}
                        </div>
                    </div>`;
            });
        }

        function openProduct(index) { showProductPage(displayedProducts[index]); }

        function showProductPage(product) {
            currentProduct = product;
            selectedSize = null;
            const price = Number(product.Price || product.price);
            
            document.getElementById('pp-img').src = product.Image || product.image;
            document.getElementById('pp-title').innerText = product.Name || product.name;
            document.getElementById('pp-header-title').innerText = (product.Name || product.name).substring(0, 15) + "...";
            document.getElementById('pp-price').innerText = price;
            document.getElementById('pp-desc').innerText = product.Description || "High quality product.";
            
            // Discount Logic
            const oldPrice = Number(getOldPrice(product));
            if (oldPrice > price) {
                const percent = Math.floor(((oldPrice - price) / oldPrice) * 100);
                document.getElementById('pp-badge').innerText = `${percent}% OFF`; 
                document.getElementById('pp-badge').classList.remove('hidden'); 
                document.getElementById('pp-discount-text').innerText = `-${percent}%`; 
                document.getElementById('pp-discount-text').classList.remove('hidden');
                document.getElementById('pp-old-price').innerText = "â‚¹" + oldPrice; 
                document.getElementById('pp-mrp-block').classList.remove('hidden');
            } else {
                document.getElementById('pp-badge').classList.add('hidden'); 
                document.getElementById('pp-discount-text').classList.add('hidden'); 
                document.getElementById('pp-mrp-block').classList.add('hidden');
            }

            // Fake Reviews Logic
            const reviewsDiv = document.getElementById('pp-reviews');
            reviewsDiv.innerHTML = "";
            let rawReviews = product.Reviews || product.reviews;
            if (!rawReviews) {
                // If no real reviews, pick random fake ones
                rawReviews = fakeReviews[Math.floor(Math.random() * fakeReviews.length)];
            }
            rawReviews.split('|').forEach(r => {
                reviewsDiv.innerHTML += `
                    <div class="text-sm border-b pb-2">
                        <div class="flex items-center gap-1 mb-1">
                            <i class="fa-solid fa-user-circle text-gray-400 text-lg"></i>
                            <span class="font-bold text-xs text-gray-700">Verified User</span>
                        </div>
                        <div class="text-yellow-500 text-xs">â˜…â˜…â˜…â˜…â˜…</div>
                        <p class="text-gray-600 text-xs mt-1">${r}</p>
                    </div>
                `;
            });

            document.querySelectorAll('.size-btn').forEach(b => { b.classList.remove('bg-[#fcd200]', 'border-[#e77600]', 'text-black'); });
            document.getElementById('size-error').classList.add('hidden');
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('product-page').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function submitReview() {
            alert("Review Submitted! Thank you.");
            document.getElementById('review-text').value = "";
        }

        function togglePaymentMethod(method) {
            const qrBox = document.getElementById('qr-box');
            const fileInput = document.getElementById('pay-screenshot');
            if (method === 'Online') {
                document.getElementById('qr-img').src = QR_CODE_IMAGE;
                qrBox.classList.remove('hidden');
                fileInput.removeAttribute('disabled');
            } else {
                qrBox.classList.add('hidden');
                fileInput.setAttribute('disabled', 'true');
            }
        }

        // --- STRICT AI PAYMENT CHECK & SUBMISSION ---
        async function submitOrder(e) {
            e.preventDefault();
            const payMethod = document.querySelector('input[name="Payment"]:checked').value;
            const fileInput = document.getElementById('pay-screenshot');
            const custName = document.getElementById('cust-name').value;
            const btn = document.getElementById('place-order-btn');
            const statusBox = document.getElementById('scan-status');
            
            // Expected Price
            const price = String(currentProduct.Price || currentProduct.price);

            if(payMethod === 'Online') {
                if(fileInput.files.length === 0) {
                    alert("Please upload payment screenshot."); return;
                }

                // Lock UI
                btn.disabled = true;
                btn.innerText = "Wait...";
                btn.classList.add("bg-gray-300");
                statusBox.classList.remove('hidden');

                try {
                    // AI Scan
                    const result = await Tesseract.recognize(fileInput.files[0], 'eng');
                    const text = result.data.text; // The scanned text
                    const cleanText = text.replace(/,/g, ''); // Handle 1,200 as 1200
                    
                    console.log("AI Scanned:", cleanText); 

                    // Check if price exists in text
                    if (!cleanText.includes(price)) {
                        alert(`âŒ VERIFICATION FAILED\n\nWe could not find "â‚¹${price}" in your screenshot.\n\nPlease upload a clear screenshot showing the correct amount.`);
                        
                        // Reset
                        btn.disabled = false;
                        btn.innerText = "Place Order";
                        btn.classList.remove("bg-gray-300");
                        statusBox.classList.add('hidden');
                        return; // STOP
                    }

                } catch (error) {
                    console.error(error);
                    alert("Scan Error. Please try again or use COD.");
                    btn.disabled = false;
                    btn.innerText = "Place Order";
                    btn.classList.remove("bg-gray-300");
                    statusBox.classList.add('hidden');
                    return;
                }
            }

            // Send Order
            btn.innerText = "Placing Order...";
            
            const formData = new FormData(document.getElementById('order-form'));
            
            fetch("https://formsubmit.co/suheemsuheem752@gmail.com", { method: "POST", body: formData })
                .then(() => { showInvoice(custName, payMethod); toggleModal('checkout-modal'); })
                .catch(() => { showInvoice(custName, payMethod); toggleModal('checkout-modal'); })
                .finally(() => { 
                    btn.disabled = false; 
                    btn.innerText = "Place Order"; 
                    btn.classList.remove("bg-gray-300"); 
                    statusBox.classList.add('hidden');
                });
        }

        function showInvoice(name, mode) {
            document.getElementById('inv-id').innerText = "#" + Math.floor(10000 + Math.random() * 90000);
            document.getElementById('inv-name').innerText = name;
            document.getElementById('inv-mode').innerText = mode;
            toggleModal('invoice-modal');
        }

        function closeProductPage() {
            document.getElementById('product-page').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        }

        function selectSize(btn, size) {
            selectedSize = size;
            document.querySelectorAll('.size-btn').forEach(b => { b.classList.remove('bg-[#fcd200]', 'border-[#e77600]', 'text-black'); });
            btn.classList.add('bg-[#fcd200]', 'border-[#e77600]', 'text-black');
            document.getElementById('size-error').classList.add('hidden');
        }

        function openCheckoutFromPage() {
            if (!selectedSize && (currentProduct.Category || "").includes("Wear")) {
                document.getElementById('size-error').classList.remove('hidden'); return;
            }
            document.getElementById('form-name').value = currentProduct.Name || currentProduct.name;
            document.getElementById('form-price').value = currentProduct.Price || currentProduct.price;
            document.getElementById('form-size').value = selectedSize || "Universal";
            document.getElementById('qr-amount-display').innerText = currentProduct.Price || currentProduct.price;
            toggleModal('checkout-modal');
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function searchProducts() { const q = document.getElementById('search').value.toLowerCase(); renderGrid(allProducts.filter(p => (p.Name || p.name).toLowerCase().includes(q))); }
        function filterProducts(c) { renderGrid(c === 'All' ? allProducts : allProducts.filter(p => (p.Category || p.category) === c)); }
        
        let taps = 0;
        function adminLoginTrigger() {
            taps++; if(taps === 5) { if(prompt("Admin Password") === "admin123") toggleModal('admin-panel'); taps = 0; }
        }
        
        function uploadProduct() {
            const btn = document.getElementById('upload-btn');
            const file = document.getElementById('a-img').files[0];
            if(!file) return alert("Select Image");
            btn.innerText = "Saving...";
            const reader = new FileReader();
            reader.onload = function(e) {
                const payload = { action: "add", name: document.getElementById('a-name').value, price: document.getElementById('a-price').value, old_price: document.getElementById('a-old-price').value, category: document.getElementById('a-cat').value, image: e.target.result, description: document.getElementById('a-desc').value };
                fetch(API_URL, { method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) }).then(() => { alert("Added!"); location.reload(); });
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
